<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>OCR chọn vùng theo 4 điểm</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    canvas { border: 1px solid #ccc; cursor: crosshair; }
    #output { white-space: pre-wrap; background: #f0f0f0; margin-top: 10px; padding: 10px; }
  </style>
</head>
<body>
  <h3>📸 Chọn ảnh và click 4 điểm theo chiều kim đồng hồ</h3>
  <input type="file" id="upload" accept="image/*"><br><br>
  <canvas id="canvas"></canvas>
  <div id="output">📝 Kết quả OCR sẽ hiển thị ở đây...</div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const output = document.getElementById("output");

    let img = new Image();
    let points = [];

    document.getElementById("upload").addEventListener("change", e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    canvas.addEventListener("click", async e => {
      if (points.length >= 4) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      points.push({ x, y });

      // Vẽ điểm vừa chọn
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, Math.PI * 2);
      ctx.fill();

      // Khi chọn đủ 4 điểm, thực hiện crop và OCR
      if (points.length === 4) {
        output.innerText = "⏳ Đang xử lý OCR...";

        // Tạo canvas tạm để crop vùng hình học
        const tempCanvas = document.createElement("canvas");
        const tempCtx = tempCanvas.getContext("2d");

        // Xác định khung chữ nhật mới
        const width = Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y);
        const height = Math.hypot(points[3].x - points[0].x, points[3].y - points[0].y);
        tempCanvas.width = width;
        tempCanvas.height = height;

        // Sử dụng context setTransform để vẽ từ 4 điểm => rectangle mới
        const [p0, p1, p2, p3] = points;

        // Dùng Path2D (đơn giản) để cắt theo vùng điểm chọn
        const path = new Path2D();
        path.moveTo(p0.x, p0.y);
        path.lineTo(p1.x, p1.y);
        path.lineTo(p2.x, p2.y);
        path.lineTo(p3.x, p3.y);
        path.closePath();

        // Dùng getImageData + putImageData nếu không dùng opencv.js
        const minX = Math.min(...points.map(p => p.x));
        const minY = Math.min(...points.map(p => p.y));
        const max
